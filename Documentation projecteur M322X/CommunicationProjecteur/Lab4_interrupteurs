#include <18F2580.h>
#include "stdlib.h"

#fuses HS, NOWDT, PUT,NOPROTECT, NOLVP
#use delay(clock=20000000)
#use RS232(Baud=9600, Xmit=PIN_C6,Rcv=PIN_C7, bits=8)


//-----------------------------------------------------//

int s=0;
int m=0;
int h=0;
int compteur;
int code;
int carry_flag = 0;	// Indique au main que compteur a chang?

void main (void)
{
	setup_timer_1(t1_internal | T1_DIV_BY_8);
	set_timer1(3035);
	enable_interrupts(INT_TIMER1);
	enable_interrupts(INT_RDA);
	enable_interrupts(GLOBAL);
	
	while(true)
	{
		if ( carry_flag==1 )
		{
		printf("%02u:%02u:%02u",h,m,s);
		putc(0xD);
		putc(0xA);
		carry_flag=0;
		}
	}
}

#INT_TIMER1
void Horloge(void)
{

	compteur++;
	if(compteur==10)
	{
		carry_flag = 1;
		s++;

		if(s==60)
		{
			m++;
			s=0;
		}
		if(m==60)
		{
			h++;
			m=0;
		}
		if(h==24)
		{
			h=0;
		}
	compteur=0;
	}	
	set_timer1(3035);
}

#INT_RDA
void MOD_CLOCK(void)
{
	if(kbhit()==1)
	{
		code=getc();

		if(code==0x2b)//+
		{
			s++;
		}
		if(code==0x2d)//-
		{
			s--;
		}
		if(code==0x6d)
		{
			m++;
		}
		if(code==0x68)
		{
			h++;
		}
	}	
}